<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON Multi-Level Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 4px solid #DC143C;
        }

        .header {
            background: #DC143C;
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 1px solid #b01030;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 0.95em;
            opacity: 0.95;
            font-weight: 300;
        }

        .content {
            padding: 25px 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #DC143C;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .section h2::before {
            content: '';
            width: 3px;
            height: 20px;
            background: #DC143C;
            border-radius: 1px;
        }

        .explanation {
            background: #fafafa;
            padding: 15px 18px;
            border-radius: 3px;
            margin-bottom: 20px;
            border-left: 3px solid #DC143C;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .hierarchy {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 20px 0;
        }

        .level {
            background: white;
            padding: 12px 15px;
            border-radius: 3px;
            border-left: 3px solid #DC143C;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .level:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 6px rgba(220,20,60,0.15);
            border-left-color: #b01030;
        }

        .level-icon {
            font-size: 1.4em;
            width: 35px;
            text-align: center;
        }

        .level-info {
            flex: 1;
        }

        .level-info h3 {
            font-size: 1em;
            margin-bottom: 3px;
            color: #333;
            font-weight: 600;
        }

        .level-info p {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .arrow {
            font-size: 1em;
            color: #DC143C;
            margin: 0 5px;
            opacity: 0.6;
        }

        .upload-area {
            border: 2px dashed #DC143C;
            border-radius: 3px;
            padding: 25px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            background: #fff5f5;
            border-color: #b01030;
        }

        .upload-area.dragover {
            background: #ffe8e8;
            border-color: #b01030;
            border-style: solid;
        }

        .upload-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 1em;
            color: #DC143C;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .upload-hint {
            color: #888;
            font-size: 0.85em;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 12px;
            padding: 10px 12px;
            background: #fff5f5;
            border-radius: 3px;
            display: none;
            border-left: 3px solid #DC143C;
        }

        .file-info.show {
            display: block;
        }

        .file-info .filename {
            font-weight: 600;
            color: #DC143C;
            font-size: 0.9em;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .option-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 3px;
            padding: 12px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .option-card:hover {
            border-color: #DC143C;
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(220,20,60,0.15);
        }

        .option-card.selected {
            border-color: #DC143C;
            background: #fff5f5;
        }

        .option-card input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-bottom: 6px;
            cursor: pointer;
            accent-color: #DC143C;
        }

        .option-card .icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }

        .option-card label {
            display: block;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            font-size: 0.9em;
        }

        .process-btn {
            background: #DC143C;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1em;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(220,20,60,0.3);
            margin: 20px auto;
            display: block;
            font-weight: 500;
        }

        .process-btn:hover {
            background: #b01030;
            box-shadow: 0 3px 6px rgba(220,20,60,0.4);
        }

        .process-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #ccc;
            box-shadow: none;
        }

        .progress {
            display: none;
            margin: 20px 0;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #DC143C;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.85em;
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 0.85em;
        }

        .results {
            display: none;
            margin-top: 20px;
        }

        .results.show {
            display: block;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .result-card {
            background: #fafafa;
            border-radius: 3px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }

        .result-card:hover {
            border-color: #DC143C;
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .result-card .icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }

        .result-card .filename {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            font-size: 0.9em;
        }

        .result-card .size {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .download-btn {
            background: #DC143C;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-size: 0.85em;
            font-weight: 500;
        }

        .download-btn:hover {
            background: #b01030;
        }

        .info-badge {
            display: inline-block;
            background: #fff5f5;
            color: #DC143C;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 0.75em;
            margin: 3px;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .processing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è GeoJSON Multi-Level Pipeline</h1>
            <p>Transform your CSV data into beautiful GeoJSON files at multiple geographic levels</p>
        </div>

        <div class="content">
            <!-- Tab Navigation -->
            <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e0e0e0;">
                <button class="tab-btn active" onclick="showTab('create')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">
                    üó∫Ô∏è Create GeoJSON
                </button>
                <button class="tab-btn" onclick="showTab('lookup')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">
                    üîç Code Lookup Tool
                </button>
            </div>

            <!-- Create GeoJSON Tab -->
            <div id="createTab" class="tab-content">
            <!-- Explanation Section -->
            <div class="section">
                <h2>What This Does</h2>
                <div class="explanation">
                    <p>This tool takes your CSV file with geographic identifiers (ZIP codes, FIPS codes, etc.) and automatically creates GeoJSON files at multiple aggregation levels. Perfect for creating choropleth maps in ArcGIS Online, web applications, or data visualization tools.</p>
                </div>

                <h2>Why Use Codes Instead of Names?</h2>
                <div class="explanation" style="background: #fff5f5; border-left: 3px solid #DC143C;">
                    <p style="font-weight: 600; margin-bottom: 12px; color: #DC143C;">Codes are standardized, unique identifiers that eliminate ambiguity and spelling errors.</p>
                    
                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üìç ZIP Codes (5-digit)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> United States Postal Service ZIP Code Tabulation Areas (ZCTA5)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> 5 digits (e.g., <code>33019</code>, <code>02134</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> Every ZIP code is unique. "Miami" could refer to the city, county, or multiple ZIP codes. <code>33101</code> is unambiguous.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üèõÔ∏è FIPS Codes (5-digit)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Federal Information Processing Standards codes for counties</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> 5 digits = State FIPS (2) + County FIPS (3), e.g., <code>12011</code> = Florida (12) + Broward County (011)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> "Dallas" could be Dallas County, TX (<code>48113</code>) or Dallas County, AL (<code>01047</code>). FIPS codes are unique nationwide and never change.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üìö ECODE (Chapter Code)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Unique identifier for Red Cross chapters</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> Numeric code (e.g., <code>1019</code>, <code>38300</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> "Red Cross of Kentucky" vs "American Red Cross Kentucky Region" vs "ARC Kentucky" - all refer to the same chapter, but <code>1019</code> is always correct.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üåç RCODE (Region Code)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Unique identifier for Red Cross regions</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> Alphanumeric (e.g., <code>01R04</code>, <code>38R28</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> Region names change over time, but codes remain stable. "Southeast Region" might become "Southeast and Caribbean Division" - the code stays the same.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üåé DCODE (Division Code)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Unique identifier for Red Cross divisions</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> Alphanumeric (e.g., <code>D25</code>, <code>D27</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> Division names are long and can be abbreviated differently. <code>D25</code> is always "Southeast and Caribbean Division" regardless of how it's written.</p>
                    </div>

                    <div style="margin-top: 20px; padding: 12px; background: #f0f0f0; border-radius: 3px;">
                        <p style="font-size: 0.9em; margin: 0;"><strong>üí° Key Benefits:</strong></p>
                        <ul style="font-size: 0.85em; margin: 8px 0 0 20px; padding: 0;">
                            <li>No spelling variations (Jefferson vs Jeffersons vs Jefferson County)</li>
                            <li>No ambiguity (Dallas city vs Dallas County vs Dallas Parish)</li>
                            <li>Standardized format (always 5 digits for FIPS, always consistent)</li>
                            <li>Never change (names change, codes stay the same)</li>
                            <li>Perfect for joins (codes match exactly, names require fuzzy matching)</li>
                            <li>International standards (FIPS is federal standard, ZIP is USPS standard)</li>
                        </ul>
                    </div>
                </div>

                <h2>Geographic Hierarchy</h2>
                <div class="hierarchy">
                    <div class="level">
                        <div class="level-icon">üì¶</div>
                        <div class="level-info">
                            <h3>ZIP Codes</h3>
                            <p>Most granular level - includes all original data fields. Perfect for detailed analysis.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üèõÔ∏è</div>
                        <div class="level-info">
                            <h3>Counties</h3>
                            <p>Aggregated from ZIP codes - includes county totals and hierarchy information.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üìö</div>
                        <div class="level-info">
                            <h3>Chapters</h3>
                            <p>Aggregated from counties - boundaries created by merging county polygons.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üåç</div>
                        <div class="level-info">
                            <h3>Regions</h3>
                            <p>Aggregated from chapters - larger geographic areas with regional totals.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üåé</div>
                        <div class="level-info">
                            <h3>Divisions</h3>
                            <p>Highest level - aggregated from regions. Perfect for high-level overviews.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="section">
                <h2>Upload Your CSV File</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">Drop your CSV file here or click to browse</div>
                    <div class="upload-hint">Your CSV should have ZIP codes, FIPS codes, ECODE/RCODE/DCODE, and geographic hierarchy columns<br><small style="color: #DC143C; font-weight: 500;">üí° Tip: Codes (ZIP, FIPS, ECODE) work better than names - see explanation above</small></div>
                    <input type="file" id="fileInput" accept=".csv">
                </div>
                <div class="file-info" id="fileInfo">
                    <span class="filename" id="fileName"></span>
                    <span id="fileSize"></span>
                </div>
            </div>

            <!-- Options Section -->
            <div class="section">
                <h2>Select Output Levels</h2>
                <p style="margin-bottom: 12px; color: #666; font-size: 0.9em;">Choose which GeoJSON files you want to create:</p>
                <div class="options">
                    <div class="option-card" data-level="zip">
                        <input type="checkbox" id="optZip" checked>
                        <div class="icon">üì¶</div>
                        <label for="optZip">ZIP Codes</label>
                        <div class="info-badge">All fields</div>
                    </div>
                    <div class="option-card" data-level="county">
                        <input type="checkbox" id="optCounty" checked>
                        <div class="icon">üèõÔ∏è</div>
                        <label for="optCounty">Counties</label>
                        <div class="info-badge">Aggregated</div>
                    </div>
                    <div class="option-card" data-level="chapter">
                        <input type="checkbox" id="optChapter">
                        <div class="icon">üìö</div>
                        <label for="optChapter">Chapters</label>
                        <div class="info-badge">Dissolved</div>
                    </div>
                    <div class="option-card" data-level="region">
                        <input type="checkbox" id="optRegion">
                        <div class="icon">üåç</div>
                        <label for="optRegion">Regions</label>
                        <div class="info-badge">Dissolved</div>
                    </div>
                    <div class="option-card" data-level="division">
                        <input type="checkbox" id="optDivision">
                        <div class="icon">üåé</div>
                        <label for="optDivision">Divisions</label>
                        <div class="info-badge">Dissolved</div>
                    </div>
                </div>
            </div>

            <!-- Process Button -->
            <button class="process-btn" id="processBtn" disabled>üöÄ Create GeoJSON Files</button>

            <!-- Progress Section -->
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="status" id="status">Ready to process...</div>
            </div>

            <!-- Results Section -->
            <div class="results" id="results">
                <h2>Generated Files</h2>
                <div class="result-grid" id="resultGrid"></div>
            </div>
            </div>

            <!-- Code Lookup Tab -->
            <div id="lookupTab" class="tab-content" style="display: none;">
                <div class="section">
                    <h2>Red Cross Code Lookup</h2>
                    <div class="explanation">
                        <p>Search for ECODE, RCODE, and DCODE by entering chapter, region, or division names. Perfect for finding the correct codes when you only know the name.</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Chapter Name</label>
                            <input type="text" id="chapterSearch" placeholder="e.g., ARC serving Mid Alabama" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em;"
                                   oninput="searchCodes()">
                            <div id="chapterResults" style="margin-top: 8px; font-size: 0.85em; color: #666;"></div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Region Name</label>
                            <input type="text" id="regionSearch" placeholder="e.g., Alabama and Mississippi Region" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em;"
                                   oninput="searchCodes()">
                            <div id="regionResults" style="margin-top: 8px; font-size: 0.85em; color: #666;"></div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Division Name</label>
                            <input type="text" id="divisionSearch" placeholder="e.g., Southeast and Caribbean Division" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em;"
                                   oninput="searchCodes()">
                            <div id="divisionResults" style="margin-top: 8px; font-size: 0.85em; color: #666;"></div>
                        </div>
                    </div>

                    <div id="codeResults" style="margin-top: 25px; padding: 20px; background: #fafafa; border-radius: 3px; border-left: 3px solid #DC143C; display: none;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #DC143C;">Found Codes</h3>
                        <div id="codeResultsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
                    </div>

                    <div style="margin-top: 25px; padding: 15px; background: #fff5f5; border-radius: 3px; border-left: 3px solid #DC143C;">
                        <p style="font-weight: 600; margin-bottom: 10px; color: #DC143C;">üì§ Upload CSV to Load Data</p>
                        <p style="font-size: 0.9em; margin-bottom: 12px;">Upload a CSV file with Chapter, Region, Division, ECODE, RCODE, and DCODE columns to enable the lookup tool.</p>
                        <input type="file" id="lookupFileInput" accept=".csv" style="display: none;" onchange="loadLookupData(event)">
                        <button onclick="document.getElementById('lookupFileInput').click()" 
                                style="padding: 8px 20px; background: #DC143C; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">
                            Upload CSV for Lookup
                        </button>
                        <div id="lookupFileInfo" style="margin-top: 10px; font-size: 0.85em; color: #666;"></div>
                    </div>

                    <div id="lookupTable" style="margin-top: 25px; display: none;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px;">All Codes</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead>
                                    <tr style="background: #f0f0f0; border-bottom: 2px solid #DC143C;">
                                        <th style="padding: 10px; text-align: left; font-weight: 600;">Chapter</th>
                                        <th style="padding: 10px; text-align: left; font-weight: 600;">ECODE</th>
                                        <th style="padding: 10px; text-align: left; font-weight: 600;">Region</th>
                                        <th style="padding: 10px; text-align: left; font-weight: 600;">RCODE</th>
                                        <th style="padding: 10px; text-align: left; font-weight: 600;">Division</th>
                                        <th style="padding: 10px; text-align: left; font-weight: 600;">DCODE</th>
                                    </tr>
                                </thead>
                                <tbody id="lookupTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // File handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        const resultGrid = document.getElementById('resultGrid');

        let selectedFile = null;

        // Upload area click
        uploadArea.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
            fileInfo.classList.add('show');
            processBtn.disabled = false;

            // Update option cards
            updateOptionCards();
        }

        // Option card interactions
        document.querySelectorAll('.option-card').forEach(card => {
            const checkbox = card.querySelector('input[type="checkbox"]');
            
            card.addEventListener('click', (e) => {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
                updateCardState(card, checkbox.checked);
            });

            checkbox.addEventListener('change', () => {
                updateCardState(card, checkbox.checked);
            });
        });

        function updateCardState(card, checked) {
            if (checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        function updateOptionCards() {
            document.querySelectorAll('.option-card').forEach(card => {
                updateCardState(card, card.querySelector('input[type="checkbox"]').checked);
            });
        }

        // Process button
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const selectedLevels = [];
            if (document.getElementById('optZip').checked) selectedLevels.push('zip');
            if (document.getElementById('optCounty').checked) selectedLevels.push('county');
            if (document.getElementById('optChapter').checked) selectedLevels.push('chapter');
            if (document.getElementById('optRegion').checked) selectedLevels.push('region');
            if (document.getElementById('optDivision').checked) selectedLevels.push('division');

            if (selectedLevels.length === 0) {
                alert('Please select at least one output level');
                return;
            }

            processBtn.disabled = true;
            progress.classList.add('show');
            results.classList.remove('show');
            resultGrid.innerHTML = '';

            // Upload file first, then process
            try {
                await uploadAndProcess(selectedLevels);
            } catch (error) {
                alert('Error: ' + error.message);
                processBtn.disabled = false;
            }
        });

        async function uploadAndProcess(levels) {
            // Step 1: Upload file
            updateProgress(10, 'Uploading CSV file...');
            
            const formData = new FormData();
            formData.append('file', selectedFile);

            const uploadResponse = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                const error = await uploadResponse.json();
                throw new Error(error.error || 'Upload failed');
            }

            const uploadData = await uploadResponse.json();
            updateProgress(20, 'File uploaded. Starting processing...');

            // Step 2: Process file
            updateProgress(30, 'Processing your data...');

            const processResponse = await fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: uploadData.filename,
                    levels: levels
                })
            });

            if (!processResponse.ok) {
                const error = await processResponse.json();
                throw new Error(error.error || 'Processing failed');
            }

            const processData = await processResponse.json();
            
            // Step 3: Display results
            updateProgress(100, 'Complete! All files generated successfully.');
            
            processData.files.forEach(file => {
                createResultCard(file.level, file.filename, file.size, file.path);
            });

            processBtn.disabled = false;
            processBtn.textContent = '‚ú® Process Complete - Upload Another File';
        }

        function updateProgress(percent, message) {
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            status.textContent = message;
        }

        function createResultCard(level, filename, sizeBytes, filepath) {
            const levelInfo = {
                zip: { icon: 'üì¶', name: 'ZIP Codes' },
                county: { icon: 'üèõÔ∏è', name: 'Counties' },
                chapter: { icon: 'üìö', name: 'Chapters' },
                region: { icon: 'üåç', name: 'Regions' },
                division: { icon: 'üåé', name: 'Divisions' }
            };

            const info = levelInfo[level] || { icon: 'üìÑ', name: level };
            const sizeMB = (sizeBytes / 1024 / 1024).toFixed(2);
            
            // filepath is already relative path from backend
            const downloadPath = filepath;

            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <div class="icon">${info.icon}</div>
                <div class="filename">${filename}</div>
                <div class="size">${sizeMB} MB</div>
                <button class="download-btn" data-filepath="${downloadPath.replace(/"/g, '&quot;')}">Download</button>
            `;

            // Add click handler
            const downloadBtn = card.querySelector('.download-btn');
            downloadBtn.addEventListener('click', () => {
                downloadFile(downloadPath);
            });

            resultGrid.appendChild(card);
            results.classList.add('show');
        }

        async function downloadFile(filepath) {
            try {
                const response = await fetch(`/api/download/${filepath}`);
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('createTab').style.display = 'none';
            document.getElementById('lookupTab').style.display = 'none';
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = '#666';
            });
            
            // Show selected tab
            if (tabName === 'create') {
                document.getElementById('createTab').style.display = 'block';
                document.querySelectorAll('.tab-btn')[0].style.borderBottomColor = '#DC143C';
                document.querySelectorAll('.tab-btn')[0].style.color = '#DC143C';
            } else {
                document.getElementById('lookupTab').style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].style.borderBottomColor = '#DC143C';
                document.querySelectorAll('.tab-btn')[1].style.color = '#DC143C';
            }
        }

        // Code Lookup functionality
        let lookupData = [];

        function parseCSVLine(line) {
            // Simple CSV parser that handles quoted fields
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result.map(v => v.replace(/^"|"$/g, ''));
        }

        function loadLookupData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                const headers = parseCSVLine(lines[0]);
                
                // Find column indices (case-insensitive, handle variations)
                const normalize = (s) => s.toLowerCase().replace(/[_\s-]/g, '');
                const chapterIdx = headers.findIndex(h => normalize(h).includes('chapter') && !normalize(h).includes('code'));
                const regionIdx = headers.findIndex(h => normalize(h) === 'region' || normalize(h).includes('region') && !normalize(h).includes('code'));
                const divisionIdx = headers.findIndex(h => normalize(h) === 'division' || normalize(h).includes('division') && !normalize(h).includes('code'));
                const ecodeIdx = headers.findIndex(h => normalize(h) === 'ecode' || normalize(h).includes('ecode'));
                const rcodeIdx = headers.findIndex(h => normalize(h) === 'rcode' || normalize(h).includes('rcode'));
                const dcodeIdx = headers.findIndex(h => normalize(h) === 'dcode' || normalize(h).includes('dcode'));

                console.log('Detected columns:', {
                    chapter: chapterIdx >= 0 ? headers[chapterIdx] : 'NOT FOUND',
                    region: regionIdx >= 0 ? headers[regionIdx] : 'NOT FOUND',
                    division: divisionIdx >= 0 ? headers[divisionIdx] : 'NOT FOUND',
                    ecode: ecodeIdx >= 0 ? headers[ecodeIdx] : 'NOT FOUND',
                    rcode: rcodeIdx >= 0 ? headers[rcodeIdx] : 'NOT FOUND',
                    dcode: dcodeIdx >= 0 ? headers[dcodeIdx] : 'NOT FOUND'
                });

                lookupData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const values = parseCSVLine(lines[i]);
                    if (values.length < headers.length) continue;
                    
                    const item = {
                        chapter: chapterIdx >= 0 && values[chapterIdx] ? values[chapterIdx].trim() : '',
                        ecode: ecodeIdx >= 0 && values[ecodeIdx] ? String(values[ecodeIdx]).replace('.0', '').trim() : '',
                        region: regionIdx >= 0 && values[regionIdx] ? values[regionIdx].trim() : '',
                        rcode: rcodeIdx >= 0 && values[rcodeIdx] ? String(values[rcodeIdx]).trim() : '',
                        division: divisionIdx >= 0 && values[divisionIdx] ? values[divisionIdx].trim() : '',
                        dcode: dcodeIdx >= 0 && values[dcodeIdx] ? String(values[dcodeIdx]).trim() : ''
                    };
                    
                    // Only add if it has at least one code
                    if (item.ecode || item.rcode || item.dcode) {
                        lookupData.push(item);
                    }
                }

                // Remove duplicates
                const seen = new Set();
                lookupData = lookupData.filter(item => {
                    const key = `${item.chapter}|${item.region}|${item.division}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });

                document.getElementById('lookupFileInfo').innerHTML = 
                    `<span style="color: #DC143C; font-weight: 600;">‚úì Loaded ${lookupData.length} unique entries</span>`;
                
                populateLookupTable();
                searchCodes();
            };
            reader.readAsText(file);
        }

        function populateLookupTable() {
            const tbody = document.getElementById('lookupTableBody');
            tbody.innerHTML = '';
            
            lookupData.forEach(item => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e0e0e0';
                row.innerHTML = `
                    <td style="padding: 8px;">${item.chapter || ''}</td>
                    <td style="padding: 8px; font-weight: 600; color: #DC143C;">${item.ecode || ''}</td>
                    <td style="padding: 8px;">${item.region || ''}</td>
                    <td style="padding: 8px; font-weight: 600; color: #DC143C;">${item.rcode || ''}</td>
                    <td style="padding: 8px;">${item.division || ''}</td>
                    <td style="padding: 8px; font-weight: 600; color: #DC143C;">${item.dcode || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('lookupTable').style.display = 'block';
        }

        function searchCodes() {
            if (lookupData.length === 0) {
                document.getElementById('chapterResults').innerHTML = '';
                document.getElementById('regionResults').innerHTML = '';
                document.getElementById('divisionResults').innerHTML = '';
                document.getElementById('codeResults').style.display = 'none';
                return;
            }

            const chapterQuery = document.getElementById('chapterSearch').value.toLowerCase().trim();
            const regionQuery = document.getElementById('regionSearch').value.toLowerCase().trim();
            const divisionQuery = document.getElementById('divisionSearch').value.toLowerCase().trim();

            // Filter results
            let results = lookupData.filter(item => {
                const matchChapter = !chapterQuery || (item.chapter && item.chapter.toLowerCase().includes(chapterQuery));
                const matchRegion = !regionQuery || (item.region && item.region.toLowerCase().includes(regionQuery));
                const matchDivision = !divisionQuery || (item.division && item.division.toLowerCase().includes(divisionQuery));
                return matchChapter && matchRegion && matchDivision;
            });

            // Show suggestions as user types
            if (chapterQuery && results.length > 0) {
                const suggestions = [...new Set(results.slice(0, 5).map(r => r.chapter))];
                document.getElementById('chapterResults').innerHTML = 
                    suggestions.length > 0 ? `<small>Found: ${suggestions.join(', ')}${results.length > 5 ? '...' : ''}</small>` : '';
            } else {
                document.getElementById('chapterResults').innerHTML = '';
            }

            if (regionQuery && results.length > 0) {
                const suggestions = [...new Set(results.slice(0, 5).map(r => r.region))];
                document.getElementById('regionResults').innerHTML = 
                    suggestions.length > 0 ? `<small>Found: ${suggestions.join(', ')}${results.length > 5 ? '...' : ''}</small>` : '';
            } else {
                document.getElementById('regionResults').innerHTML = '';
            }

            if (divisionQuery && results.length > 0) {
                const suggestions = [...new Set(results.slice(0, 5).map(r => r.division))];
                document.getElementById('divisionResults').innerHTML = 
                    suggestions.length > 0 ? `<small>Found: ${suggestions.join(', ')}${results.length > 5 ? '...' : ''}</small>` : '';
            } else {
                document.getElementById('divisionResults').innerHTML = '';
            }

            // Show results
            if (results.length > 0 && (chapterQuery || regionQuery || divisionQuery)) {
                const uniqueResults = [];
                const seen = new Set();
                results.forEach(item => {
                    const key = `${item.chapter}|${item.region}|${item.division}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueResults.push(item);
                    }
                });

                const resultsHtml = uniqueResults.slice(0, 20).map(item => `
                    <div style="padding: 12px; background: white; border: 2px solid #e0e0e0; border-radius: 3px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #333;">
                            ${item.chapter || 'N/A'}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85em;">
                            <div>
                                <strong style="color: #666;">ECODE:</strong><br>
                                <span style="color: #DC143C; font-weight: 600; font-size: 1.1em;">${item.ecode || 'N/A'}</span>
                            </div>
                            <div>
                                <strong style="color: #666;">RCODE:</strong><br>
                                <span style="color: #DC143C; font-weight: 600; font-size: 1.1em;">${item.rcode || 'N/A'}</span>
                            </div>
                            <div>
                                <strong style="color: #666;">DCODE:</strong><br>
                                <span style="color: #DC143C; font-weight: 600; font-size: 1.1em;">${item.dcode || 'N/A'}</span>
                            </div>
                        </div>
                        ${item.region ? `<div style="margin-top: 6px; font-size: 0.8em; color: #666;">Region: ${item.region}</div>` : ''}
                        ${item.division ? `<div style="margin-top: 2px; font-size: 0.8em; color: #666;">Division: ${item.division}</div>` : ''}
                    </div>
                `).join('');

                document.getElementById('codeResultsContent').innerHTML = resultsHtml;
                document.getElementById('codeResults').style.display = 'block';
            } else {
                document.getElementById('codeResults').style.display = 'none';
            }
        }

        // Initialize
        updateOptionCards();
    </script>
</body>
</html>

