<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON Multi-Level Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 4px solid #DC143C;
        }

        .header {
            background: #DC143C;
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 1px solid #b01030;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 0.95em;
            opacity: 0.95;
            font-weight: 300;
        }

        .content {
            padding: 25px 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #DC143C;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .section h2::before {
            content: '';
            width: 3px;
            height: 20px;
            background: #DC143C;
            border-radius: 1px;
        }

        .explanation {
            background: #fafafa;
            padding: 15px 18px;
            border-radius: 3px;
            margin-bottom: 20px;
            border-left: 3px solid #DC143C;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .hierarchy {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 20px 0;
        }

        .level {
            background: white;
            padding: 12px 15px;
            border-radius: 3px;
            border-left: 3px solid #DC143C;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .level:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 6px rgba(220,20,60,0.15);
            border-left-color: #b01030;
        }

        .level-icon {
            font-size: 1.4em;
            width: 35px;
            text-align: center;
        }

        .level-info {
            flex: 1;
        }

        .level-info h3 {
            font-size: 1em;
            margin-bottom: 3px;
            color: #333;
            font-weight: 600;
        }

        .level-info p {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .arrow {
            font-size: 1em;
            color: #DC143C;
            margin: 0 5px;
            opacity: 0.6;
        }

        .upload-area {
            border: 2px dashed #DC143C;
            border-radius: 3px;
            padding: 25px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            background: #fff5f5;
            border-color: #b01030;
        }

        .upload-area.dragover {
            background: #ffe8e8;
            border-color: #b01030;
            border-style: solid;
        }

        .upload-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 1em;
            color: #DC143C;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .upload-hint {
            color: #888;
            font-size: 0.85em;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 12px;
            padding: 10px 12px;
            background: #fff5f5;
            border-radius: 3px;
            display: none;
            border-left: 3px solid #DC143C;
        }

        .file-info.show {
            display: block;
        }

        .file-info .filename {
            font-weight: 600;
            color: #DC143C;
            font-size: 0.9em;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .option-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 3px;
            padding: 12px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .option-card:hover {
            border-color: #DC143C;
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(220,20,60,0.15);
        }

        .option-card.selected {
            border-color: #DC143C;
            background: #fff5f5;
        }

        .option-card input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-bottom: 6px;
            cursor: pointer;
            accent-color: #DC143C;
        }

        .option-card .icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }

        .option-card label {
            display: block;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            font-size: 0.9em;
        }

        .process-btn {
            background: #DC143C;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1em;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(220,20,60,0.3);
            margin: 20px auto;
            display: block;
            font-weight: 500;
        }

        .process-btn:hover {
            background: #b01030;
            box-shadow: 0 3px 6px rgba(220,20,60,0.4);
        }

        .process-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #ccc;
            box-shadow: none;
        }

        .progress {
            display: none;
            margin: 20px 0;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #DC143C;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.85em;
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 0.85em;
        }

        .results {
            display: none;
            margin-top: 20px;
        }

        .results.show {
            display: block;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .result-card {
            background: #fafafa;
            border-radius: 3px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }

        .result-card:hover {
            border-color: #DC143C;
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .result-card .icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }

        .result-card .filename {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            font-size: 0.9em;
        }

        .result-card .size {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .download-btn {
            background: #DC143C;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-size: 0.85em;
            font-weight: 500;
        }

        .download-btn:hover {
            background: #b01030;
        }

        .info-badge {
            display: inline-block;
            background: #fff5f5;
            color: #DC143C;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 0.75em;
            margin: 3px;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .processing {
            animation: pulse 2s infinite;
        }

        /* Accordion Styles */
        .accordion {
            margin-bottom: 20px;
        }

        .accordion-header {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 3px;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            user-select: none;
        }

        .accordion-header:hover {
            background: #efefef;
            border-color: #DC143C;
        }

        .accordion-header.active {
            background: #fff5f5;
            border-color: #DC143C;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .accordion-title {
            font-weight: 600;
            color: #333;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .accordion-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-bottom-left-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .accordion-content.active {
            border-color: #DC143C;
        }

        .accordion-content-inner {
            padding: 20px;
        }
    </style>
    <!-- Built-in Code Database -->
    <script src="lookup_data.js"></script>
    <!-- ZIP Code to FIPS Mapping -->
    <script src="zip_to_fips.js"></script>
    <!-- State Name Mapping -->
    <script src="state_names.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è GeoJSON Multi-Level Pipeline</h1>
            <p>Transform your CSV data into beautiful GeoJSON files at multiple geographic levels</p>
        </div>

        <div class="content">
            <!-- Tab Navigation -->
            <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #e0e0e0;">
                <button class="tab-btn active" onclick="showTab('lookup')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">
                    üîç Code Lookup Tool
                </button>
                <button class="tab-btn" onclick="showTab('create')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">
                    üó∫Ô∏è Create GeoJSON
                </button>
            </div>

            <!-- Code Lookup Tab -->
            <div id="lookupTab" class="tab-content">

            <!-- Collapsible Explanation Section -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('lookupAccordion')">
                    <div class="accordion-title">
                        <span>‚ÑπÔ∏è</span>
                        <span>About This Tool - Why Use Codes?</span>
                    </div>
                    <div class="accordion-icon">‚ñº</div>
                </div>
                <div id="lookupAccordion" class="accordion-content">
                    <div class="accordion-content-inner">
            <div class="section">
                <h2>Red Cross Code Lookup</h2>
                <div class="explanation">
                    <p>Built-in database of all Red Cross chapters, regions, divisions, and counties. Search by name to find ECODE, RCODE, DCODE, and FIPS codes instantly.</p>
                </div>

                <h2>Why Use Codes Instead of Names?</h2>
                <div class="explanation" style="background: #fff5f5; border-left: 3px solid #DC143C;">
                    <p style="font-weight: 600; margin-bottom: 12px; color: #DC143C;">Codes are standardized, unique identifiers that eliminate ambiguity and spelling errors.</p>
                    
                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üìç ZIP Codes (5-digit)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> United States Postal Service ZIP Code Tabulation Areas (ZCTA5)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> 5 digits (e.g., <code>33019</code>, <code>02134</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> Every ZIP code is unique. "Miami" could refer to the city, county, or multiple ZIP codes. <code>33101</code> is unambiguous.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üèõÔ∏è FIPS Codes (5-digit)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Federal Information Processing Standards codes for counties</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> 5 digits = State FIPS (2) + County FIPS (3), e.g., <code>12011</code> = Florida (12) + Broward County (011)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> "Dallas" could be Dallas County, TX (<code>48113</code>) or Dallas County, AL (<code>01047</code>). FIPS codes are unique nationwide and never change.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üìö ECODE (Chapter Code)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Unique identifier for Red Cross chapters</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> Numeric code (e.g., <code>1019</code>, <code>38300</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> "Red Cross of Kentucky" vs "American Red Cross Kentucky Region" vs "ARC Kentucky" - all refer to the same chapter, but <code>1019</code> is always correct.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üåç RCODE (Region Code)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Unique identifier for Red Cross regions</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> Alphanumeric (e.g., <code>01R04</code>, <code>38R28</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> Region names change over time, but codes remain stable. "Southeast Region" might become "Southeast and Caribbean Division" - the code stays the same.</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h3 style="font-size: 1em; margin-bottom: 8px; color: #333;">üåé DCODE (Division Code)</h3>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>What:</strong> Unique identifier for Red Cross divisions</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Format:</strong> Alphanumeric (e.g., <code>D25</code>, <code>D27</code>)</p>
                        <p style="font-size: 0.9em; margin-bottom: 8px;"><strong>Why better:</strong> Division names are long and can be abbreviated differently. <code>D25</code> is always "Southeast and Caribbean Division" regardless of how it's written.</p>
                    </div>

                    <div style="margin-top: 20px; padding: 12px; background: #f0f0f0; border-radius: 3px;">
                        <p style="font-size: 0.9em; margin: 0;"><strong>üí° Key Benefits:</strong></p>
                        <ul style="font-size: 0.85em; margin: 8px 0 0 20px; padding: 0;">
                            <li>No spelling variations (Jefferson vs Jeffersons vs Jefferson County)</li>
                            <li>No ambiguity (Dallas city vs Dallas County vs Dallas Parish)</li>
                            <li>Standardized format (always 5 digits for FIPS, always consistent)</li>
                            <li>Never change (names change, codes stay the same)</li>
                            <li>Perfect for joins (codes match exactly, names require fuzzy matching)</li>
                            <li>International standards (FIPS is federal standard, ZIP is USPS standard)</li>
                        </ul>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>

            <!-- Search Tool Section -->
            <div class="section">
                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 30px;">
                        <!-- Left: Search Boxes -->
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <button onclick="resetSearch()"
                                    style="padding: 10px 20px; background: #DC143C; color: white; border: none; border-radius: 3px; font-weight: 600; font-size: 0.9em; cursor: pointer; margin-bottom: 10px; transition: background 0.2s;"
                                    onmouseover="this.style.background='#b01030'"
                                    onmouseout="this.style.background='#DC143C'">
                                üîÑ Reset All Searches
                            </button>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">Chapter Name or ECODE</label>
                                <input type="text" id="chapterSearch" placeholder="e.g., ARC serving Mid Alabama or 1019"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>

                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">Region Name or RCODE</label>
                                <input type="text" id="regionSearch" placeholder="e.g., Alabama Region or 01R04"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>

                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">Division Name or DCODE</label>
                                <input type="text" id="divisionSearch" placeholder="e.g., Southeast Division or D25"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">ZIP Code</label>
                                <input type="text" id="zipSearch" placeholder="e.g., 33704"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>

                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">County Name</label>
                                <input type="text" id="countySearch" placeholder="e.g., Broward"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>

                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">State (shows state code + counties)</label>
                                <input type="text" id="stateSearch" placeholder="e.g., FL or Florida"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>

                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 0.9em;">FIPS Code (5-digit: State+County)</label>
                                <input type="text" id="fipsSearch" placeholder="e.g., 12011 (FL=12, Broward=011)"
                                       style="width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 3px; font-size: 0.9em; background: white; color: #333;"
                                       oninput="searchCodes()">
                            </div>
                        </div>

                        <!-- Right: Results -->
                        <div id="resultsPanel" style="min-height: 400px; padding: 20px; background: white; border: 2px solid #e0e0e0; border-radius: 3px;">
                            <div id="noResults" style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 15px;">üîç</div>
                                <div style="font-size: 1.1em; font-weight: 500;">Enter a search term to find codes</div>
                                <div style="font-size: 0.9em; margin-top: 8px; color: #bbb;">Search by Chapter, Region, Division, County, State, or FIPS</div>
                            </div>

                            <div id="codeResults" style="display: none;">
                                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #DC143C; border-bottom: 2px solid #DC143C; padding-bottom: 6px;">Red Cross Codes</h3>
                                <div id="codeResultsContent" style="display: flex; flex-direction: column; gap: 0;"></div>
                            </div>

                            <div id="countyResultsSection" style="display: none; margin-top: 25px;">
                                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #DC143C; border-bottom: 2px solid #DC143C; padding-bottom: 6px;">County & FIPS Codes</h3>
                                <div id="countyResultsContent" style="display: flex; flex-direction: column; gap: 0;"></div>
                            </div>
                        </div>
                    </div>
            </div>
            </div>

            <!-- Create GeoJSON Tab -->
            <div id="createTab" class="tab-content" style="display: none;">

            <!-- Collapsible Explanation Section -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('createAccordion')">
                    <div class="accordion-title">
                        <span>‚ÑπÔ∏è</span>
                        <span>How It Works - Geographic Hierarchy Explained</span>
                    </div>
                    <div class="accordion-icon">‚ñº</div>
                </div>
                <div id="createAccordion" class="accordion-content">
                    <div class="accordion-content-inner">
            <div class="section">
                <h2>What This Does</h2>
                <div class="explanation">
                    <p>This tool takes your CSV file with geographic identifiers (ZIP codes, FIPS codes, etc.) and automatically creates GeoJSON files at multiple aggregation levels. Perfect for creating choropleth maps in ArcGIS Online, web applications, or data visualization tools.</p>
                </div>

                <h2>Geographic Hierarchy</h2>
                <div class="hierarchy">
                    <div class="level">
                        <div class="level-icon">üì¶</div>
                        <div class="level-info">
                            <h3>ZIP Codes</h3>
                            <p>Most granular level - includes all original data fields. Perfect for detailed analysis.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üèõÔ∏è</div>
                        <div class="level-info">
                            <h3>Counties</h3>
                            <p>Aggregated from ZIP codes - includes county totals and hierarchy information.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üìö</div>
                        <div class="level-info">
                            <h3>Chapters</h3>
                            <p>Aggregated from counties - boundaries created by merging county polygons.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üåç</div>
                        <div class="level-info">
                            <h3>Regions</h3>
                            <p>Aggregated from chapters - larger geographic areas with regional totals.</p>
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="level">
                        <div class="level-icon">üåé</div>
                        <div class="level-info">
                            <h3>Divisions</h3>
                            <p>Highest level - aggregated from regions. Perfect for high-level overviews.</p>
                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="section">
                <h2>Step 1: Upload Your CSV File</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-text">Drop your CSV file here or click to browse</div>
                    <div class="upload-hint">Your CSV can have individual row-level data (multiple entries per ZIP/County) or pre-aggregated data<br><small style="color: #DC143C; font-weight: 500;">üí° Tip: This tool will automatically aggregate your data by ZIP or County</small></div>
                    <input type="file" id="fileInput" accept=".csv">
                </div>
                <div class="file-info" id="fileInfo">
                    <span class="filename" id="fileName"></span>
                    <span id="fileSize"></span>
                </div>
            </div>

            <!-- Column Detection Section -->
            <div class="section" id="columnDetectionSection" style="display: none;">
                <h2>Step 2: Configure Data Aggregation</h2>

                <!-- Granularity Level -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1em; margin-bottom: 10px; color: #333;">Input Data Level</h3>
                    <div id="detectedLevel" style="background: #fff5f5; padding: 12px; border-left: 3px solid #DC143C; border-radius: 3px; margin-bottom: 12px;">
                        <strong>Auto-detected:</strong> <span id="detectedLevelText">Analyzing...</span>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 3px; background: white;">
                            <input type="radio" name="granularity" value="zip" id="granularityZip" style="accent-color: #DC143C;">
                            <span>üì¶ ZIP Code Level (detailed)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 3px; background: white;">
                            <input type="radio" name="granularity" value="county" id="granularityCounty" style="accent-color: #DC143C;">
                            <span>üèõÔ∏è County Level (aggregated)</span>
                        </label>
                    </div>
                </div>

                <!-- Aggregation Fields -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1em; margin-bottom: 10px; color: #333;">Select Fields to Aggregate</h3>
                    <div class="explanation" style="margin-bottom: 15px;">
                        <p><strong>COUNT</strong> = Count number of rows | <strong>SUM</strong> = Add up values in a column</p>
                    </div>
                    <div id="aggregationFields" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Column Mapping -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1em; margin-bottom: 10px; color: #333;">Geographic Columns Detected</h3>
                    <div id="columnMapping" style="background: #fafafa; padding: 15px; border-radius: 3px; border: 1px solid #e0e0e0;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Options Section -->
            <div class="section" id="outputLevelsSection">
                <h2>Step 3: Select Output Levels</h2>
                <p style="margin-bottom: 12px; color: #666; font-size: 0.9em;">Choose which GeoJSON files you want to create (with hierarchical roll-ups):</p>
                <div class="options">
                    <div class="option-card" data-level="zip">
                        <input type="checkbox" id="optZip" checked>
                        <div class="icon">üì¶</div>
                        <label for="optZip">ZIP Codes</label>
                        <div class="info-badge">All fields</div>
                    </div>
                    <div class="option-card" data-level="county">
                        <input type="checkbox" id="optCounty" checked>
                        <div class="icon">üèõÔ∏è</div>
                        <label for="optCounty">Counties</label>
                        <div class="info-badge">Aggregated</div>
                    </div>
                    <div class="option-card" data-level="chapter">
                        <input type="checkbox" id="optChapter">
                        <div class="icon">üìö</div>
                        <label for="optChapter">Chapters</label>
                        <div class="info-badge">Dissolved</div>
                    </div>
                    <div class="option-card" data-level="region">
                        <input type="checkbox" id="optRegion">
                        <div class="icon">üåç</div>
                        <label for="optRegion">Regions</label>
                        <div class="info-badge">Dissolved</div>
                    </div>
                    <div class="option-card" data-level="division">
                        <input type="checkbox" id="optDivision">
                        <div class="icon">üåé</div>
                        <label for="optDivision">Divisions</label>
                        <div class="info-badge">Dissolved</div>
                    </div>
                </div>
            </div>

            <!-- Aggregation Summary -->
            <div class="section" id="aggregationSummary" style="display: none;">
                <div style="background: #fff5f5; padding: 15px; border-radius: 3px; border-left: 3px solid #DC143C;">
                    <h3 style="font-size: 1em; margin-bottom: 10px; color: #DC143C;">üìä Aggregation Summary</h3>
                    <div id="summaryContent" style="font-size: 0.9em; line-height: 1.6;"></div>
                </div>
            </div>

            <!-- Process Button -->
            <button class="process-btn" id="processBtn" disabled>üöÄ Aggregate Data & Create GeoJSON Files</button>

            <!-- Progress Section -->
            <div class="progress" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="status" id="status">Ready to process...</div>
            </div>

            <!-- Results Section -->
            <div class="results" id="results">
                <h2>Generated Files</h2>
                <div class="result-grid" id="resultGrid"></div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // File handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        const resultGrid = document.getElementById('resultGrid');

        let selectedFile = null;
        let csvData = null;
        let detectedColumns = null;
        let aggregationConfig = {
            fields: [],
            granularity: null
        };

        // Upload area click
        uploadArea.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
            fileInfo.classList.add('show');

            // Parse CSV and detect columns
            parseAndDetectColumns(file);
        }

        // Parse CSV and detect columns
        function parseAndDetectColumns(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').filter(row => row.trim());

                if (rows.length === 0) {
                    alert('CSV file is empty');
                    return;
                }

                // Parse header and first few rows
                // Remove BOM if present and clean headers
                const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, '').replace(/^\uFEFF/, ''));
                const dataRows = rows.slice(1, Math.min(100, rows.length)).map(row => {
                    return row.split(',').map(cell => cell.trim().replace(/"/g, ''));
                });

                csvData = { headers, rows: dataRows, fullText: text };

                // Detect columns
                detectColumns(headers, dataRows);
            };
            reader.readAsText(file);
        }

        // Detect column types
        function detectColumns(headers, dataRows) {
            detectedColumns = {
                zip: null,
                fips: null,
                ecode: null,
                rcode: null,
                dcode: null,
                numeric: [],
                all: headers
            };

            // Flexible column name matching
            const zipPatterns = ['zip', 'zipcode', 'zip_code', 'postal', 'postalcode'];
            const fipsPatterns = ['fips', 'county_fips', 'countyfips', 'geoid', 'county_code'];
            const ecodePatterns = ['ecode', 'chapter', 'chapter_code', 'chaptercode'];
            const rcodePatterns = ['rcode', 'region', 'region_code', 'regioncode'];
            const dcodePatterns = ['dcode', 'division', 'division_code', 'divisioncode'];

            headers.forEach((header, index) => {
                const headerLower = header.toLowerCase();

                // Check for geographic columns
                if (zipPatterns.some(p => headerLower.includes(p))) {
                    detectedColumns.zip = { name: header, index };
                } else if (fipsPatterns.some(p => headerLower.includes(p))) {
                    detectedColumns.fips = { name: header, index };
                } else if (ecodePatterns.some(p => headerLower.includes(p))) {
                    detectedColumns.ecode = { name: header, index };
                } else if (rcodePatterns.some(p => headerLower.includes(p))) {
                    detectedColumns.rcode = { name: header, index };
                } else if (dcodePatterns.some(p => headerLower.includes(p))) {
                    detectedColumns.dcode = { name: header, index };
                }

                // Check if column is numeric (sample first 10 rows)
                // Skip if this column was already identified as a geographic column
                const isGeoColumn = detectedColumns.zip?.index === index ||
                                   detectedColumns.fips?.index === index ||
                                   detectedColumns.ecode?.index === index ||
                                   detectedColumns.rcode?.index === index ||
                                   detectedColumns.dcode?.index === index;

                if (!isGeoColumn) {
                    const sample = dataRows.slice(0, 10).map(row => row[index]);
                    // Check if values are numeric (allow empty strings)
                    const numericValues = sample.filter(val => val !== '');
                    const isNumeric = numericValues.length > 0 &&
                                     numericValues.every(val => !isNaN(parseFloat(val)));

                    if (isNumeric) {
                        detectedColumns.numeric.push({ name: header, index });
                    }
                }
            });

            // Auto-detect granularity
            let detectedGranularity = 'county'; // default
            if (detectedColumns.zip) {
                detectedGranularity = 'zip';
            }

            // Update UI
            displayColumnDetection(detectedGranularity);
            processBtn.disabled = false;
        }

        // Display column detection results
        function displayColumnDetection(detectedGranularity) {
            // Show the section
            document.getElementById('columnDetectionSection').style.display = 'block';

            // Set detected level
            document.getElementById('detectedLevelText').textContent =
                detectedGranularity === 'zip' ? 'ZIP Code Level (found ZIP column)' : 'County Level (found FIPS/County column)';

            // Set radio button
            if (detectedGranularity === 'zip') {
                document.getElementById('granularityZip').checked = true;
            } else {
                document.getElementById('granularityCounty').checked = true;
            }
            aggregationConfig.granularity = detectedGranularity;

            // Display aggregation field options
            const fieldsContainer = document.getElementById('aggregationFields');
            fieldsContainer.innerHTML = '';

            // Add COUNT option
            const countOption = createAggregationFieldOption('Row Count', 'count', 'COUNT');
            fieldsContainer.appendChild(countOption);

            // Add numeric columns
            detectedColumns.numeric.forEach(col => {
                const option = createAggregationFieldOption(col.name, col.name, 'SUM', true);
                fieldsContainer.appendChild(option);
            });

            // Display column mapping
            const mappingContainer = document.getElementById('columnMapping');
            let mappingHtml = '<div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 0.9em;">';

            if (detectedColumns.zip) {
                mappingHtml += `<strong>ZIP Code:</strong><span>${detectedColumns.zip.name}</span>`;
            }
            if (detectedColumns.fips) {
                mappingHtml += `<strong>County FIPS:</strong><span>${detectedColumns.fips.name}</span>`;
            }
            if (detectedColumns.ecode) {
                mappingHtml += `<strong>Chapter (ECODE):</strong><span>${detectedColumns.ecode.name}</span>`;
            }
            if (detectedColumns.rcode) {
                mappingHtml += `<strong>Region (RCODE):</strong><span>${detectedColumns.rcode.name}</span>`;
            }
            if (detectedColumns.dcode) {
                mappingHtml += `<strong>Division (DCODE):</strong><span>${detectedColumns.dcode.name}</span>`;
            }

            mappingHtml += '</div>';
            mappingContainer.innerHTML = mappingHtml;

            // Update option cards
            updateOptionCards();

            // Show and update aggregation summary
            updateAggregationSummary();
        }

        // Update aggregation summary
        function updateAggregationSummary() {
            if (!aggregationConfig.fields || aggregationConfig.fields.length === 0) {
                document.getElementById('aggregationSummary').style.display = 'none';
                return;
            }

            document.getElementById('aggregationSummary').style.display = 'block';

            let summaryHtml = '<ul style="margin: 0; padding-left: 20px;">';
            summaryHtml += `<li><strong>Input Level:</strong> ${aggregationConfig.granularity === 'zip' ? 'ZIP Code' : 'County'}</li>`;
            summaryHtml += '<li><strong>Metrics to aggregate:</strong><ul style="margin-top: 5px;">';

            aggregationConfig.fields.forEach(field => {
                summaryHtml += `<li>${field.label}: <code>${field.type}</code></li>`;
            });

            summaryHtml += '</ul></li>';
            summaryHtml += '<li><strong>Hierarchical roll-ups:</strong> ';

            if (aggregationConfig.granularity === 'zip') {
                summaryHtml += 'ZIP ‚Üí County ‚Üí Chapter ‚Üí Region ‚Üí Division';
            } else {
                summaryHtml += 'County ‚Üí Chapter ‚Üí Region ‚Üí Division';
            }

            summaryHtml += '</li>';
            summaryHtml += '</ul>';

            document.getElementById('summaryContent').innerHTML = summaryHtml;
        }

        // Create aggregation field option
        function createAggregationFieldOption(label, fieldName, defaultType, checked = true) {
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 2px solid #e0e0e0; border-radius: 3px;';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = checked;
            checkbox.id = `agg_${fieldName}`;
            checkbox.style.cssText = 'width: 18px; height: 18px; accent-color: #DC143C;';

            const labelEl = document.createElement('label');
            labelEl.textContent = label;
            labelEl.style.cssText = 'flex: 1; font-weight: 500; cursor: pointer;';
            labelEl.htmlFor = `agg_${fieldName}`;

            const select = document.createElement('select');
            select.style.cssText = 'padding: 6px 10px; border: 1px solid #e0e0e0; border-radius: 3px; background: white;';
            select.innerHTML = `
                <option value="COUNT" ${defaultType === 'COUNT' ? 'selected' : ''}>COUNT</option>
                <option value="SUM" ${defaultType === 'SUM' ? 'selected' : ''}>SUM</option>
            `;

            // Update config on change
            const updateConfig = () => {
                if (checkbox.checked) {
                    aggregationConfig.fields = aggregationConfig.fields.filter(f => f.field !== fieldName);
                    aggregationConfig.fields.push({
                        field: fieldName,
                        type: select.value,
                        label: label
                    });
                } else {
                    aggregationConfig.fields = aggregationConfig.fields.filter(f => f.field !== fieldName);
                }
                updateAggregationSummary();
            };

            checkbox.addEventListener('change', updateConfig);
            select.addEventListener('change', updateConfig);

            // Initial config
            updateConfig();

            div.appendChild(checkbox);
            div.appendChild(labelEl);
            div.appendChild(select);

            return div;
        }

        // Update granularity on radio change
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="granularity"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    aggregationConfig.granularity = e.target.value;
                    updateAggregationSummary();
                });
            });
        });

        // Option card interactions
        document.querySelectorAll('.option-card').forEach(card => {
            const checkbox = card.querySelector('input[type="checkbox"]');
            
            card.addEventListener('click', (e) => {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
                updateCardState(card, checkbox.checked);
            });

            checkbox.addEventListener('change', () => {
                updateCardState(card, checkbox.checked);
            });
        });

        function updateCardState(card, checked) {
            if (checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        function updateOptionCards() {
            document.querySelectorAll('.option-card').forEach(card => {
                updateCardState(card, card.querySelector('input[type="checkbox"]').checked);
            });
        }

        // Process button
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const selectedLevels = [];
            if (document.getElementById('optZip').checked) selectedLevels.push('zip');
            if (document.getElementById('optCounty').checked) selectedLevels.push('county');
            if (document.getElementById('optChapter').checked) selectedLevels.push('chapter');
            if (document.getElementById('optRegion').checked) selectedLevels.push('region');
            if (document.getElementById('optDivision').checked) selectedLevels.push('division');

            if (selectedLevels.length === 0) {
                alert('Please select at least one output level');
                return;
            }

            // Validate aggregation config
            if (!aggregationConfig.fields || aggregationConfig.fields.length === 0) {
                alert('Please select at least one field to aggregate');
                return;
            }

            processBtn.disabled = true;
            progress.classList.add('show');
            results.classList.remove('show');
            resultGrid.innerHTML = '';

            // Log configuration for backend processing
            console.log('Aggregation Configuration:', {
                granularity: aggregationConfig.granularity,
                fields: aggregationConfig.fields,
                detectedColumns: detectedColumns,
                outputLevels: selectedLevels
            });

            // Upload file first, then process with aggregation
            try {
                await uploadAndProcess(selectedLevels);
            } catch (error) {
                alert('Error: ' + error.message);
                processBtn.disabled = false;
            }
        });

        async function uploadAndProcess(levels) {
            // Step 1: Upload file
            updateProgress(10, 'Uploading CSV file...');

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('aggregationConfig', JSON.stringify(aggregationConfig));

            const uploadResponse = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                const error = await uploadResponse.json();
                throw new Error(error.error || 'Upload failed');
            }

            const uploadData = await uploadResponse.json();
            updateProgress(20, 'File uploaded. Starting aggregation...');

            // Step 2: Aggregate data
            updateProgress(30, `Aggregating data at ${aggregationConfig.granularity} level...`);
            await sleep(500);

            updateProgress(40, 'Calculating hierarchical roll-ups...');
            await sleep(500);

            // Step 3: Process file
            updateProgress(50, 'Creating GeoJSON files...');

            const processResponse = await fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: uploadData.filename,
                    levels: levels,
                    aggregationConfig: aggregationConfig,
                    detectedColumns: detectedColumns
                })
            });

            if (!processResponse.ok) {
                const error = await processResponse.json();
                throw new Error(error.error || 'Processing failed');
            }

            const processData = await processResponse.json();

            // Step 4: Display results
            updateProgress(100, 'Complete! All files generated successfully.');

            processData.files.forEach(file => {
                createResultCard(file.level, file.filename, file.size, file.path);
            });

            processBtn.disabled = false;
            processBtn.textContent = '‚ú® Process Complete - Upload Another File';
        }

        function updateProgress(percent, message) {
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            status.textContent = message;
        }

        function createResultCard(level, filename, sizeBytes, filepath) {
            const levelInfo = {
                zip: { icon: 'üì¶', name: 'ZIP Codes' },
                county: { icon: 'üèõÔ∏è', name: 'Counties' },
                chapter: { icon: 'üìö', name: 'Chapters' },
                region: { icon: 'üåç', name: 'Regions' },
                division: { icon: 'üåé', name: 'Divisions' }
            };

            const info = levelInfo[level] || { icon: 'üìÑ', name: level };
            const sizeMB = (sizeBytes / 1024 / 1024).toFixed(2);
            
            // filepath is already relative path from backend
            const downloadPath = filepath;

            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <div class="icon">${info.icon}</div>
                <div class="filename">${filename}</div>
                <div class="size">${sizeMB} MB</div>
                <button class="download-btn" data-filepath="${downloadPath.replace(/"/g, '&quot;')}">Download</button>
            `;

            // Add click handler
            const downloadBtn = card.querySelector('.download-btn');
            downloadBtn.addEventListener('click', () => {
                downloadFile(downloadPath);
            });

            resultGrid.appendChild(card);
            results.classList.add('show');
        }

        async function downloadFile(filepath) {
            try {
                const response = await fetch(`/api/download/${filepath}`);
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('createTab').style.display = 'none';
            document.getElementById('lookupTab').style.display = 'none';

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = '#666';
            });

            // Show selected tab
            if (tabName === 'lookup') {
                document.getElementById('lookupTab').style.display = 'block';
                document.querySelectorAll('.tab-btn')[0].style.borderBottomColor = '#DC143C';
                document.querySelectorAll('.tab-btn')[0].style.color = '#DC143C';
            } else {
                document.getElementById('createTab').style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].style.borderBottomColor = '#DC143C';
                document.querySelectorAll('.tab-btn')[1].style.color = '#DC143C';
            }
        }

        // Accordion functionality
        function toggleAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            const header = content.previousElementSibling;

            if (content.classList.contains('active')) {
                // Collapse
                content.style.maxHeight = null;
                content.classList.remove('active');
                header.classList.remove('active');
            } else {
                // Expand
                content.classList.add('active');
                header.classList.add('active');
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        }

        // Code Lookup functionality - Built-in database
        let lookupData = [];
        let countyData = [];
        let zipData = [];
        let zipDataByState = {}; // Cache for state-based ZIP files

        // Load built-in database
        function loadBuiltInDatabase() {
            // This will be populated from the embedded lookup_data.js file
            // For now, initialize empty - will be loaded via script tag
            if (typeof LOOKUP_DATABASE !== 'undefined') {
                lookupData = LOOKUP_DATABASE.chapters || [];
                countyData = LOOKUP_DATABASE.counties || [];
                
                console.log(`‚úì Loaded ${lookupData.length} chapters and ${countyData.length} counties`);
            }
            
            // Load ZIP code mapping (full database)
            if (typeof ZIP_TO_FIPS !== 'undefined') {
                zipData = ZIP_TO_FIPS.zipCodes || [];
                console.log(`‚úì Loaded ${zipData.length} ZIP codes`);
            }
        }

        // Load ZIP codes for a specific state (on-demand)
        async function loadZipCodesForState(state) {
            if (zipDataByState[state]) {
                return zipDataByState[state];
            }
            
            // Try to load state-specific file
            const stateUpper = state.toUpperCase();
            try {
                const script = document.createElement('script');
                script.src = `zip_codes_${stateUpper}.js`;
                script.onload = function() {
                    const stateVarName = `ZIP_CODES_${stateUpper}`;
                    if (typeof window[stateVarName] !== 'undefined') {
                        zipDataByState[state] = window[stateVarName];
                        console.log(`‚úì Loaded ${zipDataByState[state].length} ZIP codes for ${state}`);
                    }
                };
                document.head.appendChild(script);
            } catch (e) {
                console.log(`Could not load ZIP codes for ${state}`);
            }
            
            return zipDataByState[state] || [];
        }

        function searchCodes() {
            // Get all search values
            const chapterQuery = document.getElementById('chapterSearch').value.trim();
            const regionQuery = document.getElementById('regionSearch').value.trim();
            const divisionQuery = document.getElementById('divisionSearch').value.trim();
            const zipQuery = document.getElementById('zipSearch').value.trim();
            const countyQuery = document.getElementById('countySearch').value.trim();
            const stateQuery = document.getElementById('stateSearch').value.trim();
            const fipsQuery = document.getElementById('fipsSearch').value.trim();

            // Check if any search is active
            const hasSearch = chapterQuery || regionQuery || divisionQuery || zipQuery || countyQuery || stateQuery || fipsQuery;
            
            if (!hasSearch) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('codeResults').style.display = 'none';
                document.getElementById('countyResultsSection').style.display = 'none';
                return;
            } else {
                document.getElementById('noResults').style.display = 'none';
            }

            // Normalize queries for flexible matching
            const normalize = (str) => str ? str.toLowerCase().trim().replace(/\s+/g, ' ') : '';
            
            // Convert state name to abbreviation if needed
            function normalizeState(stateQuery) {
                if (!stateQuery) return '';
                const normalized = normalize(stateQuery);
                // Check if it's already an abbreviation (2 letters)
                if (normalized.length === 2) {
                    return normalized.toUpperCase();
                }
                // Check if it's a full state name
                if (typeof STATE_NAMES !== 'undefined' && STATE_NAMES[normalized]) {
                    return STATE_NAMES[normalized];
                }
                // Return as-is for partial matching
                return normalized;
            }
            
            // Search Red Cross codes (forward and reverse lookup)
            let results = [];
            if (lookupData.length > 0) {
                results = lookupData.filter(item => {
                    // Chapter/ECODE search - very flexible
                    const chapterMatch = !chapterQuery || 
                        (item.Chapter && normalize(item.Chapter).includes(normalize(chapterQuery))) ||
                        (item.ECODE && item.ECODE.toString().toLowerCase().includes(normalize(chapterQuery))) ||
                        (item.ECODE && item.ECODE.toString().includes(chapterQuery.trim()));
                    
                    // Region/RCODE search - very flexible
                    const regionMatch = !regionQuery || 
                        (item.Region && normalize(item.Region).includes(normalize(regionQuery))) ||
                        (item.RCODE && item.RCODE.toString().toLowerCase().includes(normalize(regionQuery))) ||
                        (item.RCODE && item.RCODE.toString().includes(regionQuery.trim()));
                    
                    // Division/DCODE search - very flexible
                    const divisionMatch = !divisionQuery || 
                        (item.Division && normalize(item.Division).includes(normalize(divisionQuery))) ||
                        (item.DCODE && item.DCODE.toString().toLowerCase().includes(normalize(divisionQuery))) ||
                        (item.DCODE && item.DCODE.toString().includes(divisionQuery.trim()));
                    
                    return chapterMatch && regionMatch && divisionMatch;
                });
            }

            // Search ZIP codes first (if ZIP is searched, find county/FIPS)
            let zipResults = [];
            let zipFoundFIPS = null;
            if (zipQuery) {
                // Normalize ZIP to exactly 5 digits
                const zipNormalized = zipQuery.replace(/[^0-9]/g, '').substring(0, 5).padStart(5, '0');
                
                // Search in main ZIP database
                if (zipData.length > 0) {
                    // First try exact match
                    zipResults = zipData.filter(item => {
                        if (!item.Zip) return false;
                        const itemZip = item.Zip.replace(/[^0-9]/g, '').padStart(5, '0');
                        return itemZip === zipNormalized;
                    });
                    
                    // If no exact match, try partial match (first 3 digits)
                    if (zipResults.length === 0 && zipNormalized.length >= 3) {
                        const zipPrefix = zipNormalized.substring(0, 3);
                        zipResults = zipData.filter(item => {
                            if (!item.Zip) return false;
                            const itemZip = item.Zip.replace(/[^0-9]/g, '').padStart(5, '0');
                            return itemZip.startsWith(zipPrefix);
                        });
                    }
                }
                
                // If still no results, try to infer state from ZIP prefix and load state file
                if (zipResults.length === 0 && zipNormalized.length >= 3) {
                    // ZIP codes starting with 33xxx are typically Florida
                    // We could add more logic here to map ZIP prefixes to states
                    const zipPrefix = zipNormalized.substring(0, 2);
                    // Common ZIP prefixes: 33=FL, 10-12=NY/NJ/PA, etc.
                    // For now, if ZIP starts with 33, try loading FL data
                    if (zipPrefix === '33') {
                        loadZipCodesForState('FL').then(flZips => {
                            if (flZips && flZips.length > 0) {
                                const found = flZips.filter(item => {
                                    if (!item.Zip) return false;
                                    const itemZip = item.Zip.replace(/[^0-9]/g, '').padStart(5, '0');
                                    return itemZip === zipNormalized;
                                });
                                if (found.length > 0) {
                                    zipResults = found;
                                    zipFoundFIPS = found[0].FIPS;
                                    searchCodes(); // Re-run search with new data
                                }
                            }
                        });
                    }
                }
                
                if (zipResults.length > 0) {
                    // Use the FIPS from ZIP results to filter county results
                    zipFoundFIPS = zipResults[0].FIPS;
                }
            }

            // Search counties (forward and reverse lookup)
            let countyResults = [];
            if (countyData.length > 0) {
                // Normalize state query (convert full name to abbreviation if needed)
                const stateQueryNormalized = stateQuery ? normalizeState(stateQuery) : '';
                
                countyResults = countyData.filter(item => {
                    // If ZIP was searched and found a FIPS, prioritize that
                    if (zipFoundFIPS && zipQuery) {
                        return item.FIPS === zipFoundFIPS;
                    }
                    
                    const countyMatch = !countyQuery || 
                        (item.County && normalize(item.County).includes(normalize(countyQuery)));
                    
                    // State matching: convert full name to abbreviation, then match
                    let stateMatch = true;
                    if (stateQuery) {
                        const itemState = (item.State || '').toUpperCase();
                        // stateQueryNormalized is already converted to abbreviation if it was a full name
                        // Match the normalized query (which is now an abbreviation) against the item's state
                        stateMatch = itemState === stateQueryNormalized.toUpperCase() ||
                            // Also allow partial matching on the original query
                            normalize(item.State || '').includes(normalize(stateQuery));
                    }
                    
                    const fipsMatch = !fipsQuery || 
                        (item.FIPS && item.FIPS.toString().includes(fipsQuery.trim()));
                    
                    return countyMatch && stateMatch && fipsMatch;
                });
            }
            
            // If ZIP search found results, add them to county results
            if (zipResults.length > 0 && zipQuery) {
                zipResults.forEach(zipItem => {
                    // Check if this FIPS is already in countyResults
                    const exists = countyResults.some(c => c.FIPS === zipItem.FIPS);
                    if (!exists) {
                        countyResults.push({
                            FIPS: zipItem.FIPS,
                            County: zipItem.County,
                            State: zipItem.State
                        });
                    }
                });
            }

            // Get state code from FIPS (first 2 digits)
            let stateCodeInfo = null;
            if (stateQuery && countyResults.length > 0) {
                const firstCounty = countyResults[0];
                if (firstCounty.FIPS && firstCounty.FIPS.length >= 2) {
                    stateCodeInfo = {
                        state: firstCounty.State,
                        stateCode: firstCounty.FIPS.substring(0, 2)
                    };
                }
            }

            // Show Red Cross code results
            if (results.length > 0 && (chapterQuery || regionQuery || divisionQuery)) {
                const uniqueResults = [];
                const seen = new Set();
                results.forEach(item => {
                    const key = `${item.Chapter}|${item.Region}|${item.Division}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueResults.push(item);
                    }
                });

                const resultsHtml = uniqueResults.slice(0, 50).map(item => `
                    <div style="padding: 12px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 3px; border-left: 3px solid #DC143C; margin-bottom: 8px;">
                        <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr; gap: 15px; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: #333; font-size: 0.95em; margin-bottom: 4px;">
                                    ${item.Chapter || 'N/A'}
                                </div>
                                ${item.Region ? `<div style="font-size: 0.85em; color: #666;">${item.Region}</div>` : ''}
                                ${item.Division ? `<div style="font-size: 0.85em; color: #666;">${item.Division}</div>` : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #666;">
                                ${item.Region ? `<div>Region: ${item.Region}</div>` : ''}
                                ${item.Division ? `<div>Division: ${item.Division}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="margin-bottom: 6px;">
                                    <div style="font-size: 0.75em; color: #999; margin-bottom: 1px;">ECODE</div>
                                    <div style="color: #DC143C; font-weight: 700; font-size: 1.1em;">${item.ECODE || 'N/A'}</div>
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <div style="font-size: 0.75em; color: #999; margin-bottom: 1px;">RCODE</div>
                                    <div style="color: #DC143C; font-weight: 700; font-size: 1.1em;">${item.RCODE || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #999; margin-bottom: 1px;">DCODE</div>
                                    <div style="color: #DC143C; font-weight: 700; font-size: 1.1em;">${item.DCODE || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('codeResultsContent').innerHTML = resultsHtml;
                document.getElementById('codeResults').style.display = 'block';
            } else {
                document.getElementById('codeResults').style.display = 'none';
            }

            // Show ZIP code results if ZIP was searched
            if (zipQuery) {
                if (zipResults.length > 0) {
                    const zipResultsHtml = zipResults.slice(0, 10).map(item => `
                        <div style="padding: 12px; background: #fff5f5; border: 2px solid #DC143C; border-radius: 3px; margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr; gap: 15px; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; font-size: 0.95em;">
                                        ZIP Code: ${item.Zip}
                                    </div>
                                    <div style="font-size: 0.85em; color: #666; margin-top: 2px;">
                                        ${item.County || 'N/A'} County, ${item.State || 'N/A'}
                                    </div>
                                </div>
                                <div style="font-size: 0.85em; color: #666;">
                                    County FIPS Code
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #DC143C; font-weight: 700; font-size: 1.3em;">${item.FIPS || 'N/A'}</div>
                                    <div style="font-size: 0.7em; color: #999; margin-top: 2px;">
                                        State: ${item.FIPS ? item.FIPS.substring(0, 2) : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('countyResultsContent').innerHTML = zipResultsHtml;
                    document.getElementById('countyResultsSection').style.display = 'block';
                } else {
                    // ZIP not found - show message and don't show other county results
                    document.getElementById('countyResultsContent').innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #999;">
                            <div style="font-size: 1.1em; margin-bottom: 8px;">ZIP Code ${zipQuery} not found</div>
                            <div style="font-size: 0.9em;">This ZIP code is not in our database. Try searching by County Name or FIPS Code instead.</div>
                        </div>
                    `;
                    document.getElementById('countyResultsSection').style.display = 'block';
                    return; // Don't show other county results when ZIP search fails
                }
            }

            // Show county results with state code (only if ZIP was not searched, or ZIP search succeeded)
            if ((countyQuery || stateQuery || fipsQuery) && !zipQuery) {
                let countyResultsHtml = '';
                
                // Show state code if state was searched
                if (stateCodeInfo) {
                    countyResultsHtml += `
                        <div style="padding: 12px; background: #fff5f5; border: 2px solid #DC143C; border-radius: 3px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr; gap: 15px; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; font-size: 1em;">
                                        ${stateCodeInfo.state}
                                    </div>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    State Code (FIPS)
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #DC143C; font-weight: 700; font-size: 1.4em;">${stateCodeInfo.stateCode}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Show counties
                if (countyResults.length > 0) {
                    countyResultsHtml += countyResults.slice(0, 50).map(item => {
                        const stateCode = item.FIPS && item.FIPS.length >= 2 ? item.FIPS.substring(0, 2) : '';
                        return `
                            <div style="padding: 10px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 3px; border-left: 3px solid #DC143C; margin-bottom: 6px;">
                                <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr; gap: 15px; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 0.9em;">
                                            ${item.County || 'N/A'} County
                                        </div>
                                    </div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        ${item.State || ''}${stateCode ? ` (State Code: ${stateCode})` : ''}
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.75em; color: #999; margin-bottom: 1px;">FIPS</div>
                                        <div style="color: #DC143C; font-weight: 700; font-size: 1.2em;">${item.FIPS || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else if (stateQuery || fipsQuery || countyQuery) {
                    countyResultsHtml += `<div style="padding: 20px; text-align: center; color: #999;">No counties found</div>`;
                }

                if (countyResultsHtml) {
                    document.getElementById('countyResultsContent').innerHTML = countyResultsHtml;
                    document.getElementById('countyResultsSection').style.display = 'block';
                } else {
                    document.getElementById('countyResultsSection').style.display = 'none';
                }
            } else if (!zipQuery) {
                document.getElementById('countyResultsSection').style.display = 'none';
            }
        }

        // Reset all search fields
        function resetSearch() {
            document.getElementById('chapterSearch').value = '';
            document.getElementById('regionSearch').value = '';
            document.getElementById('divisionSearch').value = '';
            document.getElementById('zipSearch').value = '';
            document.getElementById('countySearch').value = '';
            document.getElementById('stateSearch').value = '';
            document.getElementById('fipsSearch').value = '';
            
            // Clear results
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('codeResults').style.display = 'none';
            document.getElementById('countyResultsSection').style.display = 'none';
            document.getElementById('codeResultsContent').innerHTML = '';
            document.getElementById('countyResultsContent').innerHTML = '';
        }

        // Initialize
        updateOptionCards();
        
        // Load built-in database when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadBuiltInDatabase);
        } else {
            // DOM already loaded
            setTimeout(loadBuiltInDatabase, 100);
        }
    </script>
</body>
</html>

